name: Create Tag in Multiple Repositories

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag to create (e.g., v1.0.0)'
        required: true
        type: string
      tag_message:
        description: 'Tag message (leave empty for lightweight tag)'
        required: false
        type: string
        default: ''
      repositories:
        description: 'Comma-separated list of repository names (same owner)'
        required: true
        type: string
        # Example: "repo1,repo2,repo3"
      ref:
        description: 'Branch or commit SHA to tag (default: main)'
        required: false
        type: string
        default: 'main'

jobs:
  create-tags:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        run: |
          if [[ ! "${{ inputs.tag_name }}" =~ ^[a-zA-Z0-9._-]+$ ]]; then
            echo "Error: Invalid tag name format"
            exit 1
          fi

      - name: Create tags in repositories
        env:
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          OWNER="${{ github.repository_owner }}"
          TAG_NAME="${{ inputs.tag_name }}"
          TAG_MESSAGE="${{ inputs.tag_message }}"
          REF="${{ inputs.ref }}"
          
          # Convert comma-separated list to array
          IFS=',' read -ra REPOS <<< "${{ inputs.repositories }}"
          
          echo "Creating tag '$TAG_NAME' in ${#REPOS[@]} repositories..."
          echo "=============================================="
          
          for repo in "${REPOS[@]}"; do
            # Trim whitespace
            repo=$(echo "$repo" | xargs)
            
            echo ""
            echo "Processing: $OWNER/$repo"
            echo "----------------------------------------------"
            
            # Get the SHA of the ref (branch or commit)
            SHA=$(gh api "repos/$OWNER/$repo/git/ref/heads/$REF" --jq '.object.sha' 2>/dev/null || echo "")
            
            # If not a branch, try as a direct SHA
            if [ -z "$SHA" ]; then
              # Verify the commit exists
              SHA=$(gh api "repos/$OWNER/$repo/git/commits/$REF" --jq '.sha' 2>/dev/null || echo "")
            fi
            
            if [ -z "$SHA" ]; then
              echo "❌ Error: Could not find ref '$REF' in $OWNER/$repo"
              continue
            fi
            
            echo "  Found SHA: $SHA"
            
            # Check if tag already exists (must check actual ref field, not exit code)
            TAG_REF=$(gh api "repos/$OWNER/$repo/git/ref/tags/$TAG_NAME" --jq '.ref' 2>/dev/null) || true
            if [ -n "$TAG_REF" ]; then
              echo "⚠️  Tag '$TAG_NAME' already exists in $OWNER/$repo - skipping"
              continue
            fi
            
            if [ -n "$TAG_MESSAGE" ]; then
              # Create annotated tag
              TAG_SHA=$(gh api "repos/$OWNER/$repo/git/tags" \
                -X POST \
                -f tag="$TAG_NAME" \
                -f message="$TAG_MESSAGE" \
                -f object="$SHA" \
                -f type="commit" \
                --jq '.sha')
              
              # Create the reference pointing to the tag object
              gh api "repos/$OWNER/$repo/git/refs" \
                -X POST \
                -f ref="refs/tags/$TAG_NAME" \
                -f sha="$TAG_SHA"
            else
              # Create lightweight tag (just a reference)
              gh api "repos/$OWNER/$repo/git/refs" \
                -X POST \
                -f ref="refs/tags/$TAG_NAME" \
                -f sha="$SHA"
            fi
            
            echo "✅ Successfully created tag '$TAG_NAME' in $OWNER/$repo"
          done
          
          echo ""
          echo "=============================================="
          echo "Tag creation complete!"
